% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/calc_rte.R
\name{calculate_queue_metrics}
\alias{calculate_queue_metrics}
\title{Calculate Queue Metrics for Rank-based Triage Effectiveness (RTE) Analysis}
\usage{
calculate_queue_metrics(
  data,
  verbose = TRUE,
  ambiguity_invalid = TRUE,
  ambiguity_perfect = TRUE
)
}
\arguments{
\item{data}{A data frame that has been initiated with init() with the following required columns:
\itemize{
\item segment: Created in init(), a grouping variable identifying distinct queue segments.
\item arrival_minute: Time of patient arrival (numeric).
\item observed_resolve_time: Time when patient was actually resolved (numeric), created by init().
\item theoretica_resolve_time: Theoretical resolution time (numeric) from sim_te(). Optional.
\item binary_theoretical_resolve_time: Theoretical resolution time when using binary priorities (numeric). Optional.
\item loset: Logical flag indicating if patient is time-critical (TRUE) or not (FALSE).
}}

\item{verbose}{logical, determines if intermediate calculation fields are returned (TRUE) or only the final RTE results (FALSE).}

\item{ambiguity_invalid}{logical, default is TRUE, sets if cases where n_tc => L are invalid since they are ambigous and thus cannot be used to draw conclusions. I.e. p = 1 theoretically gives both TE = 100\% and 0\%.}

\item{ambiguity_perfect}{logical, default is TRUE, used if ambiguity_invalit == FALSE, if TRUE, cases where n_tc => L gives 100\% TE, if false, gives 0\% TE.}
}
\value{
A data frame with the original data plus additional columns:
\itemize{
\item arrivals_up_to_now: (if verbose == TRUE) Cumulative count of arrivals at each patient's arrival time.
\item observed_resolves_before: (if verbose == TRUE) Count of patients resolved before each patient's arrival.
\item L: (if verbose == TRUE) Queue length at patient arrival (including the patient).
\item observed_p: (if verbose == TRUE) Patient's position in the resolution sequence, counting from arrival to observed resolution.
\item theoretical_p: (if verbose == TRUE) Patient's position in the theoretical resolution sequence.
\item n_tc: (if verbose == TRUE) Number of time-critical patients in the concurrent window (from last resolve before arrival to first resolve after).
\item is_cluster: Logical flag indicating if the patient is part of a time-critical cluster.
\item cluster_id: Identifier for patients belonging to the same time-critical cluster.
\item valid: Logical flag indicating if the time-critical patient's RTE calculation is valid (see details).
\item observed_RTE: Rank-based Triage Effectiveness based on observed resolution times (NA for non-time-critical patients).
\item theoretical_RTE: Rank-based Triage Effectiveness based on theoretical resolution times (NA for non-time-critical patients).
}
}
\description{
This function implements the Rank-based Triage Effectiveness (RTE) methodology to evaluate
triage system performance based on patient queue positioning rather than waiting times.
RTE measures how effectively a triage system prioritizes time-critical patients relative
to their positions in a theoretical first-come-first-served system, providing a patient-level
metric that complements the waiting time-based Triage Effectiveness (WTE) approach.
}
\details{
\subsection{Conceptual Framework}{

RTE quantifies triage performance through queue positioning rather than waiting times. It evaluates
how effectively a triage system moves time-critical patients forward in the resolution queue compared
to their position in a first-come-first-served (FCFS) system, where:
\itemize{
\item RTE = 0 means the patient's position was equivalent to FCFS (no triage benefit)
\item RTE = 1 means optimal positioning (perfect triage)
\item RTE < 0 means worse positioning than FCFS (triage was counterproductive)
}
}

\subsection{Key Metrics Calculation}{

\strong{L (Queue Length)}: Represents the number of patients in queue when a patient arrives,
including the patient themselves. This value indicates what position the patient would have in a
FCFS system.

\strong{p (Position)}: The patient's position in the resolution sequence, counting from their arrival
time to their resolution time. A p value of 1 means the patient was the first to be resolved among
all patients in queue at their arrival time.

\strong{n_tc}: Number of time-critical patients (loset=TRUE) in the concurrent window between the last resolve
before the patient's arrival and the first resolve after their arrival, including the patient themselves.
This represents the "cluster" of time-critical cases that arrived in close temporal proximity.

\strong{valid}: A time-critical patient's RTE calculation is considered valid only when triage can
make a meaningful difference. Specifically, the calculation is valid if any of these conditions are met:
\itemize{
\item There's at least one non-time-critical patient already in the queue at arrival time, OR
\item A non-time-critical patient will arrive before L resolves happen (if L = n_tc), OR
\item L ≠ n_tc (queue composition allows for meaningful prioritization)
}
This validation prevents analysis of scenarios where the order doesn't matter (e.g., when all patients
in queue are time-critical and no new non-time-critical patients arrive before they're all resolved).
}

\subsection{RTE Calculation Logic}{

The RTE formula varies depending on the queue dynamics to ensure consistent interpretation across different scenarios:
\enumerate{
\item \strong{Perfect Triage} (when p ≤ n_tc):
\itemize{
\item The patient is resolved within the first n_tc positions
\item If n_tc ≥ L and ambiguity_perfect=TRUE: RTE = 1 (perfect score)
\item If n_tc ≥ L and ambiguity_perfect=FALSE: RTE = 0
\item Otherwise (when n_tc < L): RTE = 1 (perfect score)
}
\item \strong{Positive Triage} (when n_tc < p ≤ L):
\itemize{
\item The patient is resolved after the first n_tc positions but within or at L
\item RTE = (L - p) / (L - n_tc)
}
\item \strong{Negative Triage} (when p > L):
\itemize{
\item The patient is resolved after L positions (worse than first-come, first-served)
\item RTE = (L - p) / L (this will be negative)
}
}
}

\subsection{Ambiguity Handling}{

An ambiguous case occurs when n_tc ≥ L, meaning there are as many or more time-critical patients
than the queue length. In this situation, the position would be the same with perfect prioritization
as in a first-come, first-serve system.

By default (ambiguity_invalid=TRUE), these cases are considered invalid for RTE calculation.
When ambiguity_invalid=FALSE, the result depends on ambiguity_perfect:
\itemize{
\item When ambiguity_perfect=TRUE (default): These cases are scored as "perfect" (RTE = 1)
\item When ambiguity_perfect=FALSE: These cases are scored as "zero" (RTE = 0)
}
}

\subsection{Examples}{

\strong{Example 1:} A time-critical patient arrives and finds 5 patients already in queue (L = 6).
They are the only time-critical patient in this window (n_tc = 1). They get resolved as the 2nd patient (p = 2).

Using case 3 formula: RTE = (6 - 2)/(6 - (1+1)/2) = 4/5 = 0.8

This indicates very good triage performance, moving the patient nearly to optimal position.

\strong{Example 2:} A time-critical patient arrives at an empty queue (L = 1) and is the only time-critical
patient (n_tc = 1). Before this patient is resolved, 3 non-time-critical patients arrive. The time-critical
patient gets resolved as the 3rd patient (p = 3).

Using case 4 formula: RTE = (1 + ((1+1)/2-1) - 3)/1 = -1.5

This indicates poor triage, as the time-critical patient was significantly delayed despite arriving first.

\strong{Example 3:} During a major incident, 4 time-critical patients arrive in rapid succession to an ED
with 2 patients already waiting (L = 3 for the first arriving time-critical patient, n_tc = 4). The first
time-critical patient gets resolved as the 2nd patient (p = 2).

Using case 2 formula: RTE = ((4+1)/2 - 2)/((4+1)/2 - 1) = 0.5/1.5 = 0.33

This indicates moderate triage performance within the context of a time-critical patient cluster.
}

\subsection{Differences between Rank-based TE (RTE) and Waiting time-based TE (WTE)}{
\enumerate{
\item \strong{Conceptual Focus:}
\itemize{
\item RTE measures position improvement in the queue (process metric)
\item WTE measures waiting time reduction (outcome metric)
}
\item \strong{Analytical Granularity:}
\itemize{
\item RTE provides patient-level measurements, enabling standard statistical analyses without bootstrapping
\item WTE produces aggregate measurements requiring bootstrapping for confidence intervals
}
\item \strong{Queue Dynamics Handling:}
\itemize{
\item RTE handles non-coincident arrivals and resolves better than WTE
\item WTE better reflects the actual time impact experienced by patients
}
\item \strong{Edge Case Behavior:}
\itemize{
\item RTE can punish placement severely in short queues where the time effect is minimal
\item WTE can punish EDs with lower resolve rates and fewer priority 1 cases
}
\item \strong{System Evaluation:}
\itemize{
\item RTE focuses specifically on triage decision quality regardless of system throughput
\item WTE combines effects of both triage decisions and system throughput capacity
}
\item \strong{Interpretation Differences:}
\itemize{
\item RTE measures position advantage relative to FCFS position and cluster composition
\item WTE measures time advantage relative to mean waiting time for all patients
}
\item \strong{Cross-System Comparison:}
\itemize{
\item RTE may be more stable across different ED environments with varying throughput capacities
\item WTE more directly reflects patient experience in terms of actual waiting time
}
}
}
}
\note{
This function makes specific assumptions when handling multiple patients resolved in
the same minute:

For observed_p calculation: When multiple patients are resolved in the same minute,
the function assumes that higher priority patients were resolved first, followed by
patients with equal priority in arrival order. This may not reflect the actual
sequence that occurred in practice, as this level of detail is often not captured
in typical ED datasets with minute-level resolution. The calculation therefore
interprets the observed data in the "best light" - assuming ideal priority-based
ordering within each minute.

For theoretical_p and binary_theoretical_p: The priority-based ordering is
consistent with the simulation used in sim_te() and sim_heat(), ensuring that
within the same minute, higher priority patients are always processed before
lower priority patients, and equal priority patients are processed in arrival order.

Cluster handling: The function identifies time-critical clusters when there are
multiple time-critical cases (n_tc > 1) and at least one has n_tc > L. Patients
in these clusters are evaluated using a modified RTE formula that better accounts
for the unique dynamics of clustered time-critical arrivals.

This handling is necessary to achieve consistent 100\% TE scores in scenarios
with perfect triage (100\% sensitivity and specificity), particularly when
multiple patients are resolved within the same minute or when time-critical
patients arrive in clusters.

This function makes specific assumptions when handling multiple patients resolved in
the same minute:

For observed_p calculation: When multiple patients are resolved in the same minute,
the function assumes that higher priority patients were resolved first, followed by
patients with equal priority in arrival order. This may not reflect the actual
sequence that occurred in practice, as this level of detail is often not captured
in typical ED datasets with minute-level resolution. The calculation therefore
interprets the observed data in the "best light" - assuming ideal priority-based
ordering within each minute.

For theoretical_p and binary_theoretical_p: The priority-based ordering is
consistent with the simulation used in sim_te() and sim_heat(), ensuring that
within the same minute, higher priority patients are always processed before
lower priority patients, and equal priority patients are processed in arrival order.

This handling is necessary to achieve consistent 100\% TE scores in scenarios
with perfect triage (100\% sensitivity and specificity), particularly when
multiple patients are resolved within the same minute.
}
\seealso{
\code{\link{init}} for initializing data for triage analysis
\code{\link{sim_te}} for simulating theoretical resolve times
Calculate Queue Metrics for Rank-based Triage Effectiveness (RTE) Analysis using data.table
}
