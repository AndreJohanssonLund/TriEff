<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Heatmap Analysis in trieff • trieff</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Heatmap Analysis in trieff">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">trieff</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/getting_started.html">Getting Started</a></li>
    <li><a class="dropdown-item" href="../articles/sim_te.html">Simulation in trieff</a></li>
    <li><a class="dropdown-item" href="../articles/calc_te.html">Calculating Triage Effectiveness</a></li>
    <li><a class="dropdown-item" href="../articles/bootstrap.html">Bootstrap Analysis</a></li>
    <li><a class="dropdown-item" href="../articles/plot_te.html">Plotting Results</a></li>
    <li><a class="dropdown-item" href="../articles/heatmap.html">Heatmap Analysis</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-research" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Research</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-research">
<li><a class="dropdown-item" href="../articles/original_study.html">Original Study (Under Review)</a></li>
    <li><a class="dropdown-item" href="../articles/publications.html">Publications Using trieff</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/AndreJohanssonLund/trieff/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Heatmap Analysis in trieff</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/AndreJohanssonLund/trieff/blob/HEAD/vignettes/heatmap.Rmd" class="external-link"><code>vignettes/heatmap.Rmd</code></a></small>
      <div class="d-none name"><code>heatmap.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://AndreJohanssonLund.github.io/trieff/" class="external-link">trieff</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loaded trieff 1.0.0</span></span>
<span><span class="co">#&gt; System capable of parallel processing with multisession backend</span></span>
<span><span class="co">#&gt; Maximum available workers: 16</span></span>
<span><span class="co">#&gt; Note: Individual functions will determine optimal core usage at runtime</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The heatmap functionality in trieff is primarily a research tool
designed to explore and validate the theoretical properties of Triage
Effectiveness (TE). Unlike other features in the package, heatmap
generation is computationally intensive and typically used for
understanding fundamental relationships rather than day-to-day
analysis.</p>
</div>
<div class="section level2">
<h2 id="prerequisites">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h2>
<ul>
<li><p>Understanding of TE concepts
(<code><a href="../articles/getting_started.html">vignette("getting_started")</a></code>)</p></li>
<li><p>Familiarity with simulation
(<code><a href="../articles/sim_te.html">vignette("sim_te")</a></code>)</p></li>
<li><p>Could require some computational resources.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="relationship-to-simulation">Relationship to Simulation<a class="anchor" aria-label="anchor" href="#relationship-to-simulation"></a>
</h2>
<p>The heatmap analysis builds on the simulation framework described in
<code><a href="../articles/sim_te.html">vignette("sim_te")</a></code>. However, it requires significantly more
computational resources due to repeated simulations across
sensitivity/specificity combinations.</p>
<div class="section level3">
<h3 id="important-considerations">Important Considerations<a class="anchor" aria-label="anchor" href="#important-considerations"></a>
</h3>
<ol style="list-style-type: decimal">
<li>
<strong>Computational Cost</strong>: Full heatmap generation with
typical ED datasets (&gt;100,000 visits) can take several minutes up to
hours depending on step size.</li>
<li>
<strong>Intended Use</strong>: This tool is meant for researchers
validating TE properties or comparing results across different ED
settings.</li>
<li>
<strong>Limitation</strong>: The heatmap does not naturally handle
different units and it is recommended to only simulate one unit per
heatmap.</li>
</ol>
</div>
</div>
<div class="section level2">
<h2 id="understanding-heatmap-results">Understanding Heatmap Results<a class="anchor" aria-label="anchor" href="#understanding-heatmap-results"></a>
</h2>
<p>A TE heatmap visualizes how different combinations of sensitivity and
specificity affect TE values. The key patterns we have established so
far are:</p>
<ol style="list-style-type: decimal">
<li>The sum of sensitivity and specificity must exceed 1 for positive TE
values</li>
<li>When this sum exceeds 1, improving sensitivity yields slightly
better gains</li>
<li>When below 1, improving specificity is more beneficial</li>
<li>Above rules are generally hard to validate when the sum is very
close to 1, likely due to stochastic reasons.</li>
<li>If inflow of LOSET patients are uneven during operational hours and
the mean waiting time is also uneven, such as that more time critical
cases arrives during the night when waiting times are longer the values
where the sensitivity specificity sum is close to 1 can diverge further
from 0.</li>
</ol>
<p>Let’s examine these patterns with a small dataset:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get a small sample (1 week) of data</span></span>
<span><span class="va">small_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/init.html">init</a></span><span class="op">(</span><span class="va">sem_malmo_synth</span><span class="op">[</span></span>
<span>  <span class="va">sem_malmo_synth</span><span class="op">$</span><span class="va">arrival</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">sem_malmo_synth</span><span class="op">$</span><span class="va">arrival</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>  <span class="va">sem_malmo_synth</span><span class="op">$</span><span class="va">arrival</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">sem_malmo_synth</span><span class="op">$</span><span class="va">arrival</span><span class="op">)</span> <span class="op">+</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">days</a></span><span class="op">(</span><span class="fl">7</span><span class="op">)</span>,</span>
<span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">sem_malmo_synth</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">unit</span> <span class="op">==</span> <span class="st">"medical"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># As noted before - use only one unit per sim.</span></span>
<span>    <span class="fu"><a href="../reference/init.html">init</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate heatmap data</span></span>
<span><span class="co"># WARNING: Even with this small dataset, this may take several minutes</span></span>
<span><span class="va">heatmap_data</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/sim_heat.html">sim_heat</a></span><span class="op">(</span>n_workers <span class="op">=</span> <span class="fl">12</span>, step_size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Creating segments out of dataframe 2025-03-07 13:17:05.252771"</span></span>
<span><span class="co">#&gt; [1] "Identified segments, filtering LOSET segments.."</span></span>
<span><span class="co">#&gt; [1] "Processing 527 segments with LOSET cases"</span></span>
<span><span class="co">#&gt; [1] "Starting simulations with  combinations 2025-03-07 13:17:06.284955"</span></span>
<span><span class="co">#&gt; [1] "Simulations complete 2025-03-07 13:17:44.24941"</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot_te_heatmap.html">plot_te_heatmap</a></span><span class="op">(</span><span class="va">heatmap_data</span><span class="op">)</span> <span class="co"># Create heatmap</span></span></code></pre></div>
<p><img src="heatmap_files/figure-html/example_of_heatmap-1.png" alt="A heatmap showing TE over Sensitivity/specificity, unnormalized" width="672"></p>
<p>We can also normalize the heatmap with a single argument:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_te_heatmap.html">plot_te_heatmap</a></span><span class="op">(</span><span class="va">heatmap_data</span>, normalize <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># Create heatmap</span></span></code></pre></div>
<p><img src="heatmap_files/figure-html/example_of_heatmap_normalized-1.png" alt="A heatmap showing TE over Sensitivity/specificity, normalized" width="672">
## Alternative Calculations</p>
<p>The package includes several alternative TE calculations (cube root,
log, median-based) primarily for research validation. These can be
accessed using <code>alt_calc = TRUE</code> in
<code><a href="../reference/sim_heat_alt.html">sim_heat_alt()</a></code>, i.e. it is not possible based on the
<code><a href="../reference/sim_heat.html">sim_heat()</a></code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example of alternative calculations</span></span>
<span><span class="va">alt_calc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_heat_alt.html">sim_heat_alt</a></span><span class="op">(</span><span class="va">data</span>, alt_calc <span class="op">=</span> <span class="cn">TRUE</span>, step_size <span class="op">=</span> <span class="fl">25</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/plot_te_heatmap.html">plot_te_heatmap</a></span><span class="op">(</span>show_alt_calc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Creating segments out of dataframe 2025-03-07 13:17:44.580443"</span></span>
<span><span class="co">#&gt; [1] "Processing segments."</span></span>
<span><span class="co">#&gt; [1] "Calculating global median from reference simulation 2025-03-07 13:17:45.2455"</span></span>
<span><span class="co">#&gt; [1] "Starting simulations with  combinations 2025-03-07 13:17:48.229438"</span></span>
<span><span class="co">#&gt; [1] "Simulations complete 2025-03-07 13:18:01.061832"</span></span>
<span></span>
<span><span class="va">alt_calc</span><span class="op">$</span><span class="va">te_batch</span> <span class="co"># The first possible alternative heat map</span></span></code></pre></div>
<p><img src="heatmap_files/figure-html/example_alt_calc_1-1.png" alt="The first of three heatmaps from the alternative calculations - plain TE where TE is calculated based on on different normalisation techniques" width="960"></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">alt_calc</span><span class="op">$</span><span class="va">normalized_te_batch</span> <span class="co"># The second possible alternative heat map</span></span></code></pre></div>
<p><img src="heatmap_files/figure-html/example_alt_calc_2-1.png" alt="The second of three heatmaps from the alternative calculations - normalized TE where TE is calculated based on on different normalisation techniques" width="960"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">alt_calc</span><span class="op">$</span><span class="va">all_batch</span> <span class="co"># The third possible alternative heat map</span></span></code></pre></div>
<p><img src="heatmap_files/figure-html/example_alt_calc_3-1.png" alt="The second of three heatmaps from the alternative calculations - normalized TE where TE is calculated based on on different normalisation techniques" width="960">
These alternatives help validate that the patterns we observe aren’t
artifacts of our calculation method.</p>
</div>
<div class="section level2">
<h2 id="color-scheme-options">Color Scheme Options<a class="anchor" aria-label="anchor" href="#color-scheme-options"></a>
</h2>
<p>The <code>plot_te_heatmap</code> function now supports different
color schemes through the <code>color_scheme</code> parameter. This is
particularly useful for choosing appropriate visualizations for
different audiences, including options that are colorblind-friendly.</p>
<div class="section level3">
<h3 id="available-color-schemes">Available Color Schemes<a class="anchor" aria-label="anchor" href="#available-color-schemes"></a>
</h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a 2x2 grid of heatmaps with different color schemes</span></span>
<span><span class="va">color_schemes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"triage"</span>, <span class="st">"oceansky"</span>, <span class="st">"blueorange"</span>, <span class="st">"thermalsafe"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate plots with each color scheme</span></span>
<span><span class="va">color_scheme_plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">scheme</span> <span class="kw">in</span> <span class="va">color_schemes</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">color_scheme_plots</span><span class="op">[[</span><span class="va">scheme</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_te_heatmap.html">plot_te_heatmap</a></span><span class="op">(</span></span>
<span>    <span class="va">heatmap_data</span>, </span>
<span>    normalize <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    color_scheme <span class="op">=</span> <span class="va">scheme</span>,</span>
<span>    title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">scheme</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">scheme</span>, <span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nchar</a></span><span class="op">(</span><span class="va">scheme</span><span class="op">)</span><span class="op">)</span>, <span class="st">"Scheme"</span>, sep<span class="op">=</span><span class="st">""</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Combine the plots in a grid</span></span>
<span><span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html" class="external-link">wrap_plots</a></span><span class="op">(</span><span class="va">color_scheme_plots</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="heatmap_files/figure-html/color_schemes-1.png" alt="Four heatmaps showing the same TE data with different color schemes" width="1152"></p>
<p>Each color scheme has different characteristics:</p>
<p><strong>OceanSky</strong> (default): Uses medium blue (#3a75c4),
light blue, light yellow, and gold. Fully colorblind-safe with excellent
text readability across all colors. Provides an intuitive “cool-to-warm”
progression that works well for diverse audiences.</p>
<p><strong>BlueOrange</strong>: Implements a scientifically-designed
diverging color palette based on ColorBrewer’s “RdBu” (Red-Blue) scale
(#2c7bb6, #abd9e9, #fdae61, #d7191c).</p>
<p><strong>ThermalSafe</strong>: Uses purple, light blue, yellow, and
orange. Colorblind-safe and evokes thermal imaging aesthetics. Provides
strong differentiation between values while maintaining
accessibility.</p>
<p><strong>Triage</strong>: Uses classic triage colors (red, orange,
yellow, green) familiar in healthcare settings. Not colorblind-safe but
immediately recognizable to healthcare professionals who work with
triage systems.</p>
</div>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>Heatmap analysis in trieff is a powerful research tool for
understanding TE properties, but it requires:</p>
<ol style="list-style-type: decimal">
<li><p>Significant computational resources/patience</p></li>
<li><p>Careful interpretation of results</p></li>
<li><p>Understanding of the theoretical background</p></li>
</ol>
<p>For regular TE analysis of your ED, we recommend using the main
<code><a href="../reference/calc_te.html">calc_te()</a></code> function as demonstrated in other vignettes.</p>
<p>For researchers interested in detailed heatmap analysis, we recommend
reviewing the methods section of the TE paper (see
<code><a href="../articles/original_study.html">vignette("original_study")</a></code>and ensuring sufficient
computational resources before beginning analysis.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by André Johansson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
